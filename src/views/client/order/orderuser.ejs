<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <title>Lịch sử mua hàng</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries -->
    <link href="/client/lib/lightbox/css/lightbox.min.css" rel="stylesheet">
    <link href="/client/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Bootstrap & Template -->
    <link href="/client/css/bootstrap.min.css" rel="stylesheet">
    <link href="/client/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="/client/css/order/orderuser.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">
</head>

<body>
    <%- include('../layout/header'); -%>

        <div class="container my-5">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Lịch sử mua hàng</li>
                </ol>
            </nav>

            <h2 class="mb-4">
                <i class="fas fa-shopping-bag me-2" style="color: #8BC34A;"></i>Lịch sử mua hàng
            </h2>

            <% if (orders.length===0) { %>
                <div class="alert alert-info">
                    Bạn chưa có đơn hàng nào. <a href="/products" class="alert-link">Mua ngay</a> để trải nghiệm!
                </div>
                <% } else { %>
                    <div class="row g-4">
                        <% orders.forEach(order=> { %>
                            <div class="col-12">
                                <!-- Gắn id để toast có thể cuộn tới -->
                                <div class="card order-card mb-4" id="order-<%= order.id %>">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="order-header mb-0">Đơn hàng #<%= order.id %>
                                            </h5>

                                            <span class="badge
                                        <% if(order.status==='PENDING'){ %> bg-warning text-dark
                                        <% } else if(order.status==='CONFIRMED'){ %> bg-info text-dark
                                        <% } else if(order.status==='SHIPPING'){ %> bg-primary
                                        <% } else if(order.status==='OUT_FOR_DELIVERY'){ %> bg-secondary
                                        <% } else if(order.status==='DELIVERED'){ %> bg-success
                                        <% } else if(order.status==='CANCELED'){ %> bg-danger
                                        <% } else { %> bg-light text-dark <% } %>">
                                                <% const viLabel={ PENDING: 'Chờ xử lý' , CONFIRMED: 'Đã xác nhận đơn' ,
                                                    SHIPPING: 'Đang vận chuyển' , OUT_FOR_DELIVERY: 'Đang giao hàng' ,
                                                    DELIVERED: 'Đã giao hàng' , CANCELED: 'Đã hủy' }[order.status] ||
                                                    order.status; %>
                                                    <%= viLabel %>
                                            </span>
                                        </div>

                                        <p><b>Ngày đặt:</b>
                                            <%= order.createdAt.toLocaleDateString('vi-VN') %>
                                        </p>
                                        <p><b>Thanh toán:</b>
                                            <%= order.paymentMethod %> - <%= order.paymentStatus %>
                                        </p>
                                        <p><b>Tổng tiền:</b> <span class="order-total">
                                                <%= order.totalPrice.toLocaleString() %>₫
                                            </span></p>

                                        <hr>
                                        <h6><i class="fas fa-box-open me-2"></i>Sản phẩm</h6>
                                        <div class="order-products table-responsive">
                                            <table class="table align-middle">
                                                <thead>
                                                    <tr>
                                                        <th>Hình ảnh</th>
                                                        <th>Tên sản phẩm</th>
                                                        <th class="text-center">Số lượng</th>
                                                        <th class="text-end">Giá</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% order.orderDetails.forEach(item=> { %>
                                                        <tr>
                                                            <td style="width: 80px;">
                                                                <img src="/images/product/<%= item.product.image %>"
                                                                    alt="<%= item.product.name %>"
                                                                    class="img-fluid rounded"
                                                                    style="max-width: 60px; max-height: 60px; object-fit: cover;">
                                                            </td>
                                                            <td>
                                                                <%= item.product.name %>
                                                            </td>
                                                            <td class="text-center">
                                                                <%= item.quantity %>
                                                            </td>
                                                            <td class="text-end">
                                                                <%= item.price.toLocaleString() %>₫
                                                            </td>
                                                        </tr>
                                                        <% }) %>
                                                </tbody>
                                            </table>
                                        </div>

                                        <!-- NHẮC ĐÁNH GIÁ: hiện khi đã giao và chưa đánh giá -->
                                        <% var isDelivered=(order.status==='DELIVERED' );var items=order.orderDetails ||
                                            []; var first=items.length ? items[0] : null; var pid=first ?
                                            (first.productId || (first.product ? first.product.id : null)) : null; var
                                            reviewed=false; if (first && typeof first.hasReviewed !=='undefined' ) {
                                            reviewed=!!first.hasReviewed; } else { reviewed=(order.isReviewed===true); }
                                            %>

                                            <% if (isDelivered && pid) { %>
                                                <% if (reviewed) { %>
                                                    <div class="alert alert-success mt-3 mb-0" role="alert">
                                                        <i class="fas fa-check-circle me-2"></i>
                                                        Cảm ơn bạn đã đánh giá!
                                                    </div>
                                                    <% } else { %>
                                                        <div class="alert alert-success d-flex align-items-center justify-content-between mt-3 mb-0"
                                                            role="alert">
                                                            <div class="me-3">
                                                                <i class="fas fa-star me-2"></i>
                                                                Đơn hàng của bạn đã được giao. Hãy đánh giá để giúp
                                                                chúng tôi phục vụ tốt hơn!
                                                            </div>
                                                            <a href="/product/<%= pid %>?review=1#reviewsSection"
                                                                class="btn btn-outline-success btn-sm">
                                                                Đánh giá ngay
                                                            </a>
                                                        </div>
                                                        <% } %>
                                                            <% } %>


                                    </div>
                                </div>
                            </div>
                            <% }) %>
                    </div>
                    <% } %>
        </div>

        <%- include('../layout/footer'); -%>

            <a href="#" class="btn btn-primary border-3 border-primary rounded-circle back-to-top"
                aria-label="Lên đầu trang">
                <i class="fa fa-arrow-up"></i>
            </a>

            <!-- TOAST NHẮC ĐÁNH GIÁ (hiện 1 lần mỗi phiên) -->
            <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
                <div id="reviewToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"
                    data-bs-delay="9000">
                    <div class="toast-header">
                        <i class="fas fa-bell me-2" aria-hidden="true"></i>
                        <strong class="me-auto">Đánh giá đơn hàng</strong>
                        <small>Gợi ý</small>
                        <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast"
                            aria-label="Đóng"></button>
                    </div>
                    <div class="toast-body">
                        Bạn có <span id="reviewCount">0</span> đơn đã giao đang chờ đánh giá.
                        <a id="toastReviewLink" href="#" class="btn btn-primary btn-sm ms-2">Đánh giá ngay</a>
                    </div>
                </div>
            </div>

            <!-- Scripts -->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
            <script src="/client/lib/easing/easing.min.js"></script>
            <script src="/client/lib/waypoints/waypoints.min.js"></script>
            <script src="/client/lib/lightbox/js/lightbox.min.js"></script>
            <script src="/client/lib/owlcarousel/owl.carousel.min.js"></script>
            <script src="/client/js/main.js"></script>

            <!-- Logic bật toast tự động khi có ít nhất 1 đơn đã giao mà chưa đánh giá -->
            <script>
                (function () {
                    // Lấy các card đơn đã giao nhưng chưa đánh giá (đã được gắn class needs-review ở bước 1)
                    const reviewCards = Array.from(document.querySelectorAll('.order-card.needs-review'));
                    if (reviewCards.length === 0) return;

                    const shownKey = 'reviewToastShown';
                    if (sessionStorage.getItem(shownKey)) return;

                    const toastEl = document.getElementById('reviewToast');
                    const reviewCountEl = document.getElementById('reviewCount');
                    const reviewLinkEl = document.getElementById('toastReviewLink');

                    if (!(toastEl && window.bootstrap && bootstrap.Toast)) return;

                    // Cập nhật số lượng và link cuộn tới card đầu tiên
                    reviewCountEl.textContent = String(reviewCards.length);
                    const firstId = reviewCards[0].id || (reviewCards[0].getAttribute('id'));
                    if (firstId) reviewLinkEl.setAttribute('href', '#' + firstId);

                    new bootstrap.Toast(toastEl).show();
                    sessionStorage.setItem(shownKey, '1');
                })();
            </script>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    var url = new URL(window.location.href);
                    var open = (url.searchParams.get('review') === '1') || (url.hash.indexOf('reviews') !== -1);
                    if (open) {
                        var acc = document.getElementById('accReviews');
                        if (acc) acc.classList.add('show');
                        var sec = document.getElementById('reviewsSection');
                        if (sec) sec.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            </script>

</body>

</html>