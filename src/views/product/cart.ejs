<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>
        Giỏ hàng - LaptopShop
    </title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap"
        rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="/client/lib/lightbox/css/lightbox.min.css" rel="stylesheet">
    <link href="/client/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">


    <!-- Customized Bootstrap Stylesheet -->
    <link href="/client/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="/client/css/style.css" rel="stylesheet">

    <link rel="stylesheet" href="/client/css/product/cart.css">

</head>

<body>


    <!-- Spinner Start -->
    <div id="spinner"
        class="show w-100 vh-100 bg-white position-fixed translate-middle top-50 start-50  d-flex align-items-center justify-content-center">
        <div class="spinner-grow text-primary" role="status"></div>
    </div>
    <!-- Spinner End -->


    <!-- Navbar start -->
    <div class="container-fluid shadow " style="margin-top: 10px">
        <div class="container topbar bg-primary d-none d-lg-block">
            <div class="d-flex justify-content-between">
                <div class="top-info ps-2">
                    <% if(user){ %>
                        <small class="me-3"><i class="fas fa-map-marker-alt me-2 text-secondary"></i>
                            <a href="" class="text-white">
                                <!-- <%= user?.address ?? "" %> -->
                                <%= user?.address || "" %>
                            </a>
                        </small>
                        <small class="me-3"><i class="fas fa-envelope me-2 text-secondary"></i>
                            <a href="" class="text-white">
                                <%= user?.username || "" %>
                            </a>
                        </small>
                        <% } else { %>
                            <small class="me-3"><i class="fas fa-voicemail me-2 text-secondary"></i>
                            </small>
                            <% } %>
                </div>
                <div class="top-link pe-2">
                    <a href="/terms" class="text-white"><small class="text-white mx-2">Điều khoản sử
                            dụng</small>/</a>
                    <a href="/support" class="text-white"><small class="text-white mx-2">Hỗ trợ</small></a>
                </div>
            </div>
        </div>
        <div class="container px-0">
            <nav class="navbar navbar-light bg-white navbar-expand-xl">
                <div>
                    <img src="/images/logo/logo.png" alt="LaptopShop" class="logo-circle">
                </div>
                <a href="/" class="navbar-brand">
                    <h1 class="text-primary display-6">LaptopShop</h1>
                </a>
                <button class="navbar-toggler py-2 px-3" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarCollapse">
                    <span class="fa fa-bars text-primary"></span>
                </button>
                <div class="collapse navbar-collapse bg-white" id="navbarCollapse">
                    <div class="navbar-nav mx-auto">
                        <a href="/" class="nav-item nav-link active">Trang chủ</a>
                        <a href="/products" class="nav-item nav-link">Sản phẩm</a>
                        <a href="/about" class="nav-item nav-link">Giới thiệu</a>
                        <a href="/contact" class="nav-item nav-link">Liên hệ</a>
                        <a href="/terms" class="nav-item nav-link active" hidden>Điều khoản</a>
                        <a href="/blogs" class="nav-item nav-link">Blog</a>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="policyDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                Thông tin và chính sách
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="policyDropdown">
                                <li><a class="dropdown-item" href="/warranty">Chính sách bảo hành</a></li>
                                <li><a class="dropdown-item" href="/return">Chính sách đổi trả</a></li>
                                <li><a class="dropdown-item" href="/privacy">Chính sách bảo mật</a></li>
                            </ul>
                        </li>

                    </div>
                    <div class="d-flex m-3 me-0">
                        <a href="#" class="position-relative me-4 my-auto">
                            <i class="fa fa-shopping-bag fa-2x"></i>
                            <span
                                class="position-absolute bg-secondary rounded-circle d-flex align-items-center justify-content-center text-dark px-1"
                                style="top: -5px; left: 15px; height: 20px; min-width: 20px;">
                                <%= user?.sumCart ?? 0%>
                            </span>
                        </a>
                        <% if(user){ %>
                            <div class="dropdown my-auto">
                                <a href="#" class="dropdown" role="button" id="dropdownMenuLink"
                                    data-bs-toggle="dropdown" aria-expanded="false" data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                    <i class="fas fa-user fa-2x"></i>
                                </a>

                                <ul class="dropdown-menu dropdown-menu-end p-4" aria-labelledby="dropdownMenuLink">
                                    <li class="d-flex align-items-center flex-column" style="min-width: 300px;">
                                        <img style="width: 150px; height: 150px; border-radius: 50%; overflow: hidden;"
                                            src="/images/<%= user.avatar %>" />
                                        <div class="text-center my-3">
                                            <%= user.fullName %>
                                        </div>
                                    </li>

                                    <li><a class="dropdown-item" href="/profile">Thông tin cá nhân</a></li>
                                    <li><a class="dropdown-item" href="/order-history">Lịch sử mua hàng</a></li>
                                    <li><a class="dropdown-item" href="/order-user">Đơn hàng của tôi</a></li>

                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li>
                                        <form method="post" action="/logout">
                                            <button class="dropdown-item">Đăng xuất</button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                            <% }else { %>
                                <a href="/login" class="a-login">
                                    <i class="fas fa-user fa-2x"></i>
                                </a>
                                <% } %>
                    </div>
                </div>
            </nav>
        </div>
    </div>
    <!-- Navbar End -->

    <div class='py-3'></div>

    <!-- Cart Page Start -->
    <div class="container py-5">

        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-white shadow-sm p-3 rounded">
                <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Trang chủ</a></li>
                <li class="breadcrumb-item active" aria-current="page">Chi Tiết Giỏ Hàng</li>
            </ol>
        </nav>

        <% if(user && user.sumCart> 0) { %>
            <div class="row g-4 mt-3">
                <!-- Cart Items -->
                <div class="col-lg-8">
                    <h5 class="fw-bold mb-4" style="color: #8BC34A;">
                        <i class="fa fa-shopping-cart me-2 text-primary"></i>Giỏ hàng của bạn
                    </h5>
                    <div class="card shadow-sm rounded-3 border-0">
                        <div class="card-body p-0">
                            <% var totalPrice=0; %>
                                <% for(var i=0; i < cartDetails.length; i++) { var cartDetail=cartDetails[i]; var
                                    priceAfterDiscount=cartDetail.product.discount> 0
                                    ? Math.round(cartDetail.product.price * (100 - cartDetail.product.discount) / 100)
                                    : cartDetail.product.price;
                                    var itemTotal = priceAfterDiscount * cartDetail.quantity;
                                    totalPrice += itemTotal;
                                    var formattedPrice = new Intl.NumberFormat('vi-VN', {style:'currency',
                                    currency:'VND'}).format(priceAfterDiscount);
                                    var formattedItemTotal = new Intl.NumberFormat('vi-VN', {style:'currency',
                                    currency:'VND'}).format(itemTotal);
                                    var formattedOriginalPrice = new Intl.NumberFormat('vi-VN', {style:'currency',
                                    currency:'VND'}).format(cartDetail.product.price);
                                    %>
                                    <!-- Item Row -->
                                    <div class="cart-item d-grid align-items-center py-3 px-3 border-bottom"
                                        style="grid-template-columns: 80px 1fr 150px 150px 40px; gap: 15px;">
                                        <!-- Ảnh -->
                                        <div>
                                            <img src="/images/product/<%= cartDetail.product.image %>"
                                                class="rounded shadow-sm"
                                                style="width:80px; height:80px; object-fit:cover;" alt="">
                                        </div>

                                        <!-- Tên + Giá -->
                                        <div>
                                            <a href="/product/<%= cartDetail.product.id %>"
                                                class="fw-semibold text-dark text-decoration-none d-block">
                                                <%= cartDetail.product.name %>
                                            </a>
                                            <% if(cartDetail.product.discount> 0) { %>
                                                <p class="mb-1 text-decoration-line-through text-muted small">
                                                    <%= formattedOriginalPrice %>
                                                </p>
                                                <p class="fw-bold text-danger fs-5 mb-3">
                                                    <%= formattedPrice %>
                                                </p>
                                                <% } else { %>
                                                    <p class="text-dark fs-5 fw-bold mb-3">
                                                        <%= formattedPrice %>
                                                    </p>
                                                    <% } %>
                                        </div>

                                        <!-- Số lượng -->
                                        <div class="d-flex justify-content-center align-items-center">
                                            <button type="button"
                                                class="btn btn-outline-success btn-sm rounded-circle btn-minus"
                                                data-index="<%= i %>">
                                                <i class="fa fa-minus" style="color: #8BC34A;"></i>
                                            </button>
                                            <input type="text"
                                                class="form-control text-center border-0 fw-semibold cart-qty mx-1"
                                                style="width:50px;" value="<%= cartDetail.quantity %>"
                                                data-cart-detail-id="<%= cartDetail.id %>"
                                                data-cart-detail-price="<%= priceAfterDiscount %>"
                                                data-cart-detail-index="<%= i %>">

                                            <button type="button"
                                                class="btn btn-outline-success btn-sm rounded-circle btn-plus"
                                                data-index="<%= i %>">
                                                <i class="fa fa-plus" style="color: #8BC34A;"></i>
                                            </button>
                                        </div>

                                        <!-- Thành tiền -->
                                        <div class="text-danger fw-bold text-end cart-item-total"
                                            data-cart-detail-id="<%= cartDetail.id %>">
                                            <p class="fw-bold text-danger fs-5 mb-3">
                                                <%= formattedItemTotal %>
                                            </p>
                                        </div>

                                        <!-- Xóa -->
                                        <form action="/delete-product-in-cart/<%= cartDetail.id %>" method="post">
                                            <button class="btn-delete" type="submit">
                                                <i class="fa fa-trash text-danger"></i>
                                            </button>
                                        </form>
                                    </div>
                                    <% } %>
                        </div>
                    </div>
                </div>

                <!-- Checkout Summary -->
                <div class="col-lg-4">
                    <div class="card shadow-sm rounded-3 border-0 sticky-top" style="top: 20px; z-index: 10;">
                        <div class="card-body">
                            <h4 class="mb-4 fw-semibold"><i class="fa fa-box-open me-2"
                                    style="color: #8BC34A;"></i>Thông tin đơn hàng</h4>

                            <% var formattedTotalPrice=new Intl.NumberFormat('vi-VN', {style:'currency',
                                currency:'VND'}).format(totalPrice); %>

                                <div class="d-flex justify-content-between mb-2">
                                    <span>Tạm tính</span>
                                    <span id="cart-subtotal" class="fw-bold text-primary"
                                        data-cart-total-price="<%= totalPrice %>">
                                        <%= formattedTotalPrice %>
                                    </span>
                                </div>

                                <div class="d-flex justify-content-between mb-2">
                                    <span>Phí vận chuyển</span>
                                    <span class="fw-bold">0 đ</span>
                                </div>

                                <hr>

                                <div class="d-flex justify-content-between mb-3">
                                    <span class="fw-semibold fs-5">Tổng cộng</span>
                                    <span id="cart-total" class="fw-bold text-danger fs-5"
                                        data-cart-total-price="<%= totalPrice %>">
                                        <%= formattedTotalPrice %>
                                    </span>
                                </div>

                                <form action="/handle-cart-to-checkout" method="post" id="checkout-form">
                                    <input type="hidden" name="cartId" value="<%= cartId %>">
                                    <% for (var i=0; i<cartDetails.length; i++) { var cd=cartDetails[i]; %>
                                        <input type="hidden" name="cartDetails[<%= i %>][id]" value="<%= cd.id %>">
                                        <input type="hidden" name="cartDetails[<%= i %>][quantity]"
                                            value="<%= cd.quantity %>">
                                        <% } %>
                                            <button type="submit"
                                                class="btn btn-primary w-100 rounded-pill py-3 fw-bold text-uppercase">
                                                Xác nhận đặt hàng
                                            </button>
                                </form>
                        </div>
                    </div>
                </div>
            </div>
            <% } %>




    </div>


    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-white-50 footer pt-5 mt-5">
        <div class="container py-5">
            <div class="row g-5">
                <!-- Logo & Giới thiệu -->
                <div class="col-lg-3 col-md-6">
                    <a href="/" class="d-inline-block mb-3">
                        <h2 class="text-primary fw-bold">LaptopShop</h2>
                    </a>
                    <p class="small">
                        Chúng tôi cam kết mang đến sản phẩm <span class="text-light">chính hãng</span>,
                        dịch vụ tận tâm và giá cả cạnh tranh nhất.
                    </p>
                    <!-- Icon mạng xã hội -->
                    <div class="d-flex pt-2">
                        <a class="btn btn-outline-light btn-social me-2 rounded-circle" href="#"><i
                                class="fab fa-facebook-f"></i></a>
                        <a class="btn btn-outline-light btn-social me-2 rounded-circle" href="#"><i
                                class="fab fa-instagram"></i></a>
                        <a class="btn btn-outline-light btn-social me-2 rounded-circle" href="#"><i
                                class="fab fa-youtube"></i></a>
                        <a class="btn btn-outline-light btn-social rounded-circle" href="#"><i
                                class="fab fa-tiktok"></i></a>
                    </div>
                </div>

                <!-- Thông tin cửa hàng -->
                <div class="col-lg-3 col-md-6">
                    <h4 class="text-light mb-3">Thông tin cửa hàng</h4>
                    <a class="btn-link d-block mb-2" href="/about">Về chúng tôi</a>
                    <a class="btn-link d-block mb-2" href="/privacy">Chính sách bảo mật</a>
                    <a class="btn-link d-block mb-2" href="/terms">Điều khoản & dịch vụ</a>
                    <a class="btn-link d-block" href="/support">FAQs & Hỗ trợ</a>
                </div>

                <!-- Tài khoản -->
                <div class="col-lg-3 col-md-6">
                    <h4 class="text-light mb-3">Tài khoản</h4>
                    <a class="btn-link d-block mb-2" href="#">Tài khoản của tôi</a>
                    <a class="btn-link d-block mb-2" href="/cart">Giỏ hàng</a>
                    <a class="btn-link d-block mb-2" href="/order-user">Đơn hàng</a>
                    <a class="btn-link d-block" href="/blogs">Blogs</a>
                </div>

                <!-- Liên hệ -->
                <div class="col-lg-3 col-md-6">
                    <h4 class="text-light mb-3">Liên hệ</h4>
                    <p><i class="fas fa-map-marker-alt me-2 text-primary"></i>99 ABC, Thống Nhất, Gò Vấp</p>
                    <p><i class="fas fa-envelope me-2 text-primary"></i>vuonghuynhitk3@gmail.com</p>
                    <p><i class="fas fa-phone-alt me-2 text-primary"></i>0999 887 744</p>
                    <p><i class="fas fa-clock me-2 text-primary"></i>Cả tuần (8:00 - 20:00)</p>
                    <!-- Form đăng ký nhận tin -->
                    <form class="mt-3">
                        <div class="input-group">
                            <input type="email" class="form-control border-0" placeholder="Nhập email của bạn">
                            <button class="btn btn-primary">Đăng ký</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Copyright -->
    <div class="container-fluid copyright bg-black py-3">
        =======
        <div class="container-fluid bg-dark copyright bg-black py-3">

            <div class="container d-flex flex-column flex-md-row justify-content-between text-center text-md-start">
                <span class="text-light mb-2 mb-md-0">
                    <i class="fas fa-copyright me-2"></i>2025
                    <a href="#" class="text-primary fw-bold">VuongHuynh-LaptopShop</a>. All rights reserved.
                </span>
                <span class="text-white">
                    Designed by <a class="text-primary border-bottom" href="https://htmlcodex.com">HTML Codex</a> |
                    Distributed by <a class="text-primary border-bottom" href="https://themewagon.com">ThemeWagon</a>
                </span>
            </div>
        </div>
        <!-- Footer End -->

        <!-- Back to Top -->
        <a href="#" class="btn btn-primary border-3 border-primary rounded-circle back-to-top"><i
                class="fa fa-arrow-up"></i></a>


        <!-- JavaScript Libraries -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/client/lib/easing/easing.min.js"></script>
        <script src="/client/lib/waypoints/waypoints.min.js"></script>
        <script src="/client/lib/lightbox/js/lightbox.min.js"></script>
        <script src="/client/lib/owlcarousel/owl.carousel.min.js"></script>

        <!-- Template Javascript -->
        <script src="/client/js/main.js"></script>
        <script>
            // Thay đoạn JS cập nhật số lượng bằng phiên bản sync với #checkout-form
            document.addEventListener("DOMContentLoaded", () => {
                const formatVND = (n) => new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(n);

                const updateTotals = () => {
                    let subtotal = 0;

                    document.querySelectorAll(".cart-item").forEach((item) => {
                        const qtyInput = item.querySelector(".cart-qty");
                        const price = parseInt(qtyInput.dataset.cartDetailPrice) || 0;
                        const index = qtyInput.dataset.cartDetailIndex;
                        const quantity = Math.max(1, parseInt(qtyInput.value) || 1);

                        // Cập nhật hidden input TRONG #checkout-form theo index
                        const hiddenInForm = document.querySelector(
                            `#checkout-form input[name="cartDetails[${index}][quantity]"]`
                        );
                        if (hiddenInForm) hiddenInForm.value = quantity;

                        // Tính & hiển thị thành tiền từng sản phẩm
                        const itemTotal = price * quantity;
                        subtotal += itemTotal;
                        const itemTotalEl = item.querySelector(".cart-item-total p");
                        if (itemTotalEl) itemTotalEl.textContent = formatVND(itemTotal);
                    });

                    // Tổng cộng
                    const subEl = document.getElementById("cart-subtotal");
                    const totEl = document.getElementById("cart-total");
                    if (subEl) subEl.textContent = formatVND(subtotal);
                    if (totEl) totEl.textContent = formatVND(subtotal);
                };

                // Sự kiện +/- (giữ nguyên code gốc, chỉ gọi updateTotals sau khi đổi value)
                document.querySelectorAll(".btn-plus, .btn-minus").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        const index = btn.dataset.index;
                        const qtyInput = document.querySelector(`.cart-qty[data-cart-detail-index="${index}"]`);
                        let value = Math.max(1, parseInt(qtyInput.value) || 1);
                        value += btn.classList.contains("btn-plus") ? 1 : value > 1 ? -1 : 0;
                        qtyInput.value = value;
                        updateTotals();
                    });
                });

                // Sửa trực tiếp bằng bàn phím
                document.querySelectorAll(".cart-qty").forEach((input) => {
                    input.addEventListener("input", () => {
                        input.value = Math.max(1, parseInt(input.value) || 1);
                        updateTotals();
                    });
                });

                updateTotals();
            });


        </script>




</body>

</html>