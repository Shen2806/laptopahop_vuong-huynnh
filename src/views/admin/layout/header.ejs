<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <!-- Font Awesome cho icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Badge notification */
        #notificationBadge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: red;
            color: white;
            font-size: 12px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }

        /* Container icon chuông */
        .notification-icon {
            position: relative;
            cursor: pointer;
        }

        /* Rung icon khi có notification */
        .notification-icon.ring {
            animation: ring 0.5s ease-in-out 0s 2;
        }

        @keyframes ring {
            0% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(15deg);
            }

            50% {
                transform: rotate(-15deg);
            }

            75% {
                transform: rotate(10deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }
    </style>
</head>

<body>
    <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
        <!-- Navbar Brand-->
        <a class="navbar-brand ps-3" href="/">Laptopshop</a>

        <!-- Sidebar Toggle-->
        <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Navbar Search-->
        <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">
            <span style="color: white;">Welcome, Admin!</span>
        </form>

        <!-- Navbar Right -->
        <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
            <!-- Notification Icon -->
            <li class="nav-item dropdown me-3">
                <div class="notification-icon" id="notificationDropdown" style="top:3px;">
                    <i class="fas fa-bell fa-lg text-white"></i>
                    <span id="notificationBadge">0</span>
                </div>
            </li>

            <!-- User Dropdown -->
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown"
                    aria-expanded="false"><i class="fas fa-user fa-fw"></i></a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                    <li><a class="dropdown-item" href="#!">Cài đặt</a></li>
                    <li>
                        <hr class="dropdown-divider" />
                    </li>
                    <li>
                        <form method="post" action="/logout">
                            <button class="dropdown-item">Đăng xuất</button>
                        </form>
                    </li>
                </ul>
            </li>
        </ul>
        <!-- Panel dropdown notification cho Admin -->
        <div id="aNotificationPanel" class="dropdown-menu show"
            style="display:none; position:absolute; right:70px; top:55px; width:360px; max-height:420px; overflow:auto;">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                <strong>Thông báo</strong>
                <button id="aMarkAllRead" class="btn btn-sm btn-link">Đánh dấu đã đọc</button>
            </div>
            <ul id="aNotificationList" class="list-group list-group-flush"></ul>
        </div>

        <!-- Âm thanh -->
        <audio id="aNotificationSound" src="/ring.wav" preload="auto"></audio>
    </nav>
    <!-- Socket.IO client -->
    <script src="/socket.io/socket.io.js"></script>

    <script>
        const aBadge = document.getElementById('notificationBadge');
        const aIcon = document.getElementById('notificationDropdown');
        const aPanel = document.getElementById('aNotificationPanel');
        const aList = document.getElementById('aNotificationList');
        const aSound = document.getElementById('aNotificationSound');

        // Toggle panel
        aIcon.addEventListener('click', () => {
            aPanel.style.display = (aPanel.style.display === 'none' || aPanel.style.display === '') ? 'block' : 'none';
            aIcon.classList.remove('ring');
        });

        function aUpdateBadge(delta = 1) {
            let cur = parseInt(aBadge.textContent || "0", 10);
            cur = isNaN(cur) ? 0 : cur;
            cur += delta;
            if (cur <= 0) {
                aBadge.style.display = "none";
                aBadge.textContent = "0";
            } else {
                aBadge.style.display = "flex";
                aBadge.textContent = cur > 9 ? "9+" : String(cur);
            }
        }

        function aPrepend(itemHtml) {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.innerHTML = itemHtml;
            aList.prepend(li);
        }

        function aRing() {
            aIcon.classList.add('ring');
            try { aSound.currentTime = 0; aSound.play(); } catch { }
        }

        document.getElementById('aMarkAllRead').addEventListener('click', () => {
            aBadge.style.display = 'none'; aBadge.textContent = '0';
        });

        // Socket
        const aSocket = io(); // same origin
        aSocket.on('connect', () => {
            aSocket.emit('join-admin-room');
        });

        // User đặt hàng -> admin nhận
        aSocket.on('new-order', (data) => {
            aRing();
            aUpdateBadge(1);
            const url = `/admin/order/${data.orderId}`;
            aPrepend(`
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="fw-semibold">Đơn #${data.orderId} từ ${data.customerName || 'khách hàng'}</div>
          <small class="text-muted">${new Date(data.createdAt || Date.now()).toLocaleString('vi-VN')}</small>
        </div>
        <a href="${url}" class="btn btn-sm btn-primary ms-2">Xem</a>
      </div>
    `);
        });

        // Mọi cập nhật đơn (xác nhận/hủy/đổi trạng thái)
        aSocket.on('order-updated', (data) => {
            aRing();
            aUpdateBadge(1);
            const url = `/admin/order/${data.orderId}`;
            aPrepend(`
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="fw-semibold">Đơn #${data.orderId} cập nhật: ${data.status}</div>
          <small class="text-muted">${new Date().toLocaleString('vi-VN')}</small>
        </div>
        <a href="${url}" class="btn btn-sm btn-primary ms-2">Xem</a>
      </div>
    `);
        });
    </script>
</body>

</html>