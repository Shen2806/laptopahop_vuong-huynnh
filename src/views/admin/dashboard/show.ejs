<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Dashboard - LaptopShop</title>

    <!-- Base -->
    <link href="/admin/css/styles.css" rel="stylesheet" />
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Chart.js v4 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/admin/css/dashboard/show.css">
    
</head>

<body class="sb-nav-fixed">
    <%- include('../layout/header'); -%>

        <div id="layoutSidenav">
            <%- include('../layout/sidenav'); -%>

                <div id="layoutSidenav_content">
                    <main>
                        <div class="container-fluid px-4">
                            <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
                                <h1 class="page-title">Dashboard</h1>
                                <ol class="breadcrumb mb-0">
                                    <li class="breadcrumb-item active">Dashboard</li>
                                </ol>
                            </div>

                            <!-- Banner doanh thu -->
                            <div class="alert glass d-flex justify-content-between align-items-center fs-5 fw-bold mb-4"
                                style="background:linear-gradient(135deg, rgba(79, 140, 255, .18), rgba(139, 92, 246, .18));">
                                <span>üí∞ T·ªïng doanh thu:
                                    <%= new
                                        Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND'}).format(info?.totalRevenue
                                        ?? 0) %>
                                </span>
                                <small class="text-muted">* Ch·ªâ t√≠nh ƒë∆°n ƒë√£ thanh to√°n</small>
                            </div>

                            <!-- KPI -->
                            <div class="row g-4">
                                <div class="col-xl-4 col-md-6">
                                    <div class="kpi accent-primary">
                                        <div class="body">
                                            <div>
                                                <div class="lbl">Ng∆∞·ªùi d√πng</div>
                                                <div class="val">
                                                    <%= info?.countUser ?? 0 %>
                                                </div>
                                            </div>
                                            <div class="icon"><i class="fa-solid fa-users"></i></div>
                                        </div>
                                        <div class="card-footer d-flex align-items-center justify-content-between">
                                            <a class="text-light text-decoration-none fw-semibold px-3 py-2 d-inline-block"
                                                href="/admin/user">Xem ng∆∞·ªùi d√πng</a>
                                            <div class="text-white-50 me-3"><i class="fas fa-angle-right"></i></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xl-4 col-md-6">
                                    <div class="kpi accent-danger">
                                        <div class="body">
                                            <div>
                                                <div class="lbl">S·∫£n ph·∫©m</div>
                                                <div class="val">
                                                    <%= info?.countProduct ?? 0 %>
                                                </div>
                                            </div>
                                            <div class="icon"><i class="fa-solid fa-box-open"></i></div>
                                        </div>
                                        <div class="card-footer d-flex align-items-center justify-content-between">
                                            <a class="text-light text-decoration-none fw-semibold px-3 py-2 d-inline-block"
                                                href="/admin/product">Xem s·∫£n ph·∫©m</a>
                                            <div class="text-white-50 me-3"><i class="fas fa-angle-right"></i></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xl-4 col-md-6">
                                    <div class="kpi accent-success">
                                        <div class="body">
                                            <div>
                                                <div class="lbl">ƒê∆°n h√†ng</div>
                                                <div class="val">
                                                    <%= info?.countOrder ?? 0 %>
                                                </div>
                                            </div>
                                            <div class="icon"><i class="fa-solid fa-receipt"></i></div>
                                        </div>
                                        <div class="card-footer d-flex align-items-center justify-content-between">
                                            <a class="text-light text-decoration-none fw-semibold px-3 py-2 d-inline-block"
                                                href="/admin/order">Xem ƒë∆°n h√†ng</a>
                                            <div class="text-white-50 me-3"><i class="fas fa-angle-right"></i></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- QUICK ACTIONS = c√°c danh m·ª•c t·ª´ sidenav -->
                            <div class="card glass mt-4">
                                <div class="card-header"><i class="fa-solid fa-compass me-2"></i> L·ªëi t·∫Øt t√≠nh nƒÉng
                                </div>
                                <div class="card-body">
                                    <div class="qa-grid">
                                        <a class="qa-item" href="/admin/user">
                                            <span class="qa-ico"><i class="fa-solid fa-users"></i></span>
                                            <div>
                                                <div class="qa-title">Ng∆∞·ªùi d√πng</div>
                                                <div class="qa-sub">Qu·∫£n l√Ω t√†i kho·∫£n</div>
                                            </div>
                                        </a>
                                        <a class="qa-item" href="/admin/product">
                                            <span class="qa-ico"><i class="fa-solid fa-box-open"></i></span>
                                            <div>
                                                <div class="qa-title">S·∫£n ph·∫©m</div>
                                                <div class="qa-sub">Danh m·ª•c & chi ti·∫øt</div>
                                            </div>
                                        </a>
                                        <a class="qa-item" href="/admin/inventory">
                                            <span class="qa-ico"><i class="fa-solid fa-warehouse"></i></span>
                                            <div>
                                                <div class="qa-title">T·ªìn kho</div>
                                                <div class="qa-sub">Theo d√µi & ƒëi·ªÅu ch·ªânh</div>
                                            </div>
                                        </a>
                                        <a class="qa-item" href="/admin/order">
                                            <span class="qa-ico"><i class="fa-solid fa-receipt"></i></span>
                                            <div>
                                                <div class="qa-title">ƒê∆°n h√†ng</div>
                                                <div class="qa-sub">X·ª≠ l√Ω & tr·∫°ng th√°i</div>
                                            </div>
                                        </a>
                                        <a class="qa-item" href="/admin/blog">
                                            <span class="qa-ico"><i class="fa-solid fa-blog"></i></span>
                                            <div>
                                                <div class="qa-title">Blog</div>
                                                <div class="qa-sub">Tin t·ª©c & b√†i vi·∫øt</div>
                                            </div>
                                        </a>
                                        <a class="qa-item" href="/admin/promo">
                                            <span class="qa-ico"><i class="fa-solid fa-tags"></i></span>
                                            <div>
                                                <div class="qa-title">Khuy·∫øn m√£i</div>
                                                <div class="qa-sub">Thi·∫øt l·∫≠p gi·∫£m gi√°</div>
                                            </div>
                                        </a>
                                        <a class="qa-item" href="/admin/coupon">
                                            <span class="qa-ico"><i class="fa-solid fa-ticket-alt"></i></span>
                                            <div>
                                                <div class="qa-title">M√£ gi·∫£m gi√°</div>
                                                <div class="qa-sub">Coupon & h·∫°n d√πng</div>
                                            </div>
                                        </a>
                                        <a class="qa-item" href="/admin/chat">
                                            <span class="qa-ico"><i class="fa-solid fa-comments"></i></span>
                                            <div>
                                                <div class="qa-title">Tin nh·∫Øn</div>
                                                <div class="qa-sub">Tr·∫£ l·ªùi kh√°ch</div>
                                            </div>
                                        </a>
                                        <a class="qa-item" href="/admin/qa">
                                            <span class="qa-ico"><i class="fa-regular fa-circle-question"></i></span>
                                            <div>
                                                <div class="qa-title">Q&A s·∫£n ph·∫©m</div>
                                                <div class="qa-sub">C√¢u h·ªèi & ph·∫£n h·ªìi</div>
                                            </div>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- H√†ng b·ªë c·ª•c ch√≠nh: Low stock / Promo / Charts -->
                            <div class="row mt-4 g-4">
                                <!-- Low stock -->
                                <div class="col-xl-4 col-lg-6">
                                    <div class="card glass h-100">
                                        <div class="card-header d-flex align-items-center gap-2">
                                            <i class="fa-solid fa-triangle-exclamation me-1"></i>
                                            S·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng
                                            <span class="badge b-warn ms-2">
                                                <%= (info?.lowStockProducts||[]).length %>
                                            </span>
                                        </div>
                                        <div class="card-body">
                                            <% if(info?.lowStockProducts?.length>0){ %>
                                                <ul class="list-group list-group-flush">
                                                    <% info.lowStockProducts.forEach(p=>{ %>
                                                        <li
                                                            class="list-group-item d-flex justify-content-between align-items-center">
                                                            <span>
                                                                <%= p.name %>
                                                            </span>
                                                            <div class="d-flex align-items-center gap-2">
                                                                <span class="badge b-bad rounded-pill">
                                                                    <%= p.quantity %>
                                                                </span>
                                                                <button class="btn btn-sm btn-soft"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#restockModal"
                                                                    data-product-id="<%= p.id %>"
                                                                    data-product-name="<%= p.name %>">
                                                                    Nh·∫≠p th√™m
                                                                </button>
                                                            </div>
                                                        </li>
                                                        <% }) %>
                                                </ul>
                                                <% } else { %>
                                                    <span class="text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o s·∫Øp h·∫øt h√†ng</span>
                                                    <% } %>
                                        </div>
                                        <div class="card-footer d-flex align-items-center justify-content-between">
                                            <a class="text-decoration-none fw-semibold text-light"
                                                href="/admin/inventory">Qu·∫£n l√Ω kho</a>
                                            <div class="text-white-50"><i class="fas fa-angle-right"></i></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Promo products -->
                                <div class="col-xl-4 col-lg-6">
                                    <div class="card glass h-100">
                                        <div class="card-header d-flex align-items-center gap-2">
                                            <i class="fa-solid fa-tags me-1"></i>
                                            S·∫£n ph·∫©m khuy·∫øn m√£i
                                            <span class="badge b-ok ms-2">
                                                <%= (info?.promoProducts||[]).length %>
                                            </span>
                                        </div>
                                        <div class="card-body">
                                            <% if(info?.promoProducts?.length>0){ %>
                                                <ul class="list-group list-group-flush">
                                                    <% info.promoProducts.forEach(p=>{ %>
                                                        <li
                                                            class="list-group-item d-flex justify-content-between align-items-center">
                                                            <span>
                                                                <%= p.name %>
                                                            </span>
                                                            <span class="badge b-ok fw-bold">- <%= p.discount %>%</span>
                                                        </li>
                                                        <% }) %>
                                                </ul>
                                                <% } else { %>
                                                    <span class="text-muted">Hi·ªán ch∆∞a c√≥ s·∫£n ph·∫©m khuy·∫øn m√£i</span>
                                                    <% } %>
                                        </div>
                                        <div class="card-footer d-flex align-items-center justify-content-between">
                                            <a class="text-decoration-none fw-semibold text-light"
                                                href="/admin/promo">Qu·∫£n l√Ω khuy·∫øn m√£i</a>
                                            <div class="text-white-50"><i class="fas fa-angle-right"></i></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Charts column -->
                                <div class="col-xl-4">
                                    <div class="card glass mb-4">
                                        <div class="card-header d-flex align-items-center gap-2">
                                            <i class="fas fa-chart-pie me-1"></i> T·ªâ l·ªá s·∫£n ph·∫©m khuy·∫øn m√£i
                                        </div>
                                        <div class="card-body">
                                            <canvas id="promoShare" data-total="<%= info?.countProduct ?? 0 %>"
                                                data-promo="<%= (info?.promoProducts||[]).length %>"></canvas>
                                        </div>
                                    </div>

                                    <div class="card glass">
                                        <div class="card-header d-flex align-items-center gap-2">
                                            <i class="fas fa-chart-line me-1"></i> Top s·∫£n ph·∫©m b√°n ch·∫°y
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-wrap">
                                                <canvas id="topProducts"
                                                    data-labels='<%- JSON.stringify(info?.topProducts?.map(p => p.name) || []) %>'
                                                    data-values='<%- JSON.stringify(info?.topProducts?.map(p => p.quantitySold) || []) %>'></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Modal nh·∫≠p th√™m (gi·ªØ logic c≈©) -->
                            <div class="modal fade" id="restockModal" tabindex="-1" aria-labelledby="restockModalLabel"
                                aria-hidden="true">
                                <div class="modal-dialog">
                                    <form id="restockForm" method="post" action="/admin/product/restock">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="restockModalLabel">Nh·∫≠p th√™m h√†ng</h5>
                                                <button type="button" class="btn-close"
                                                    data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <input type="hidden" name="productId" id="restockProductId">
                                                <div class="mb-3">
                                                    <label class="form-label">S·∫£n ph·∫©m</label>
                                                    <input type="text" class="form-control" id="restockProductName"
                                                        disabled>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">S·ªë l∆∞·ª£ng th√™m</label>
                                                    <input type="number" name="quantity" class="form-control" min="1"
                                                        required>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary"
                                                    data-bs-dismiss="modal">H·ªßy</button>
                                                <button type="submit" class="btn btn-primary">X√°c nh·∫≠n</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                        </div>
                    </main>
                    <%- include('../layout/footer'); -%>
                </div>
        </div>

        <!-- Bootstrap -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            crossorigin="anonymous"></script>
        <script src="/admin/js/scripts.js"></script>

        <!-- Helpers + Charts -->
        <script>
            // ƒëi·ªÅn d·ªØ li·ªáu modal "Nh·∫≠p th√™m"
            const restockModal = document.getElementById('restockModal');
            if (restockModal) {
                restockModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget; if (!button) return;
                    document.getElementById('restockProductId').value = button.getAttribute('data-product-id') || '';
                    document.getElementById('restockProductName').value = button.getAttribute('data-product-name') || '';
                });
            }

            document.addEventListener('DOMContentLoaded', function () {
                // Donut t·ªâ l·ªá s·∫£n ph·∫©m khuy·∫øn m√£i
                (function () {
                    const el = document.getElementById('promoShare'); if (!el) return;
                    const total = Number(el.dataset.total || 0);
                    const promo = Number(el.dataset.promo || 0);
                    const normal = Math.max(0, total - promo);
                    new Chart(el.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Khuy·∫øn m√£i', 'Kh√¥ng KM'],
                            datasets: [{
                                data: [promo, normal],
                                backgroundColor: ['rgba(34,197,94,0.85)', 'rgba(79,140,255,0.65)'],
                                borderColor: ['rgba(34,197,94,1)', 'rgba(79,140,255,1)'],
                                borderWidth: 1.5
                            }]
                        },
                        options: { cutout: '62%', plugins: { legend: { labels: { color: '#cbd5ff' } } } }
                    });
                })();

                // Bar ngang top b√°n ch·∫°y
                (function () {
                    const el = document.getElementById('topProducts'); if (!el) return;
                    const labels = JSON.parse(el.dataset.labels || '[]');
                    const values = JSON.parse(el.dataset.values || '[]');
                    const ctx = el.getContext('2d');
                    const grad = ctx.createLinearGradient(0, 0, 600, 0);
                    grad.addColorStop(0, 'rgba(79,140,255,0.9)');
                    grad.addColorStop(1, 'rgba(139,92,246,0.6)');
                    const borderGrad = ctx.createLinearGradient(0, 0, 600, 0);
                    borderGrad.addColorStop(0, 'rgba(79,140,255,1)');
                    borderGrad.addColorStop(1, 'rgba(139,92,246,1)');
                    new Chart(ctx, {
                        type: 'bar',
                        data: { labels, datasets: [{ label: 'S·ªë l∆∞·ª£ng ƒë√£ b√°n', data: values, backgroundColor: grad, borderColor: borderGrad, borderWidth: 1.5, borderRadius: 10, barThickness: 'flex', categoryPercentage: .72, maxBarThickness: 46 }] },
                        options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#cbd5ff', precision: 0 }, grid: { color: 'rgba(255,255,255,.06)' } }, y: { ticks: { color: '#cbd5ff' }, grid: { display: false } } } }
                    });
                })();
            });
        </script>
</body>

</html>